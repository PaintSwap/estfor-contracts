import {ethers, upgrades} from "hardhat";
import {
  CLANS_ADDRESS,
  EGG_INSTANT_VRF_ACTION_STRATEGY_ADDRESS,
  ESTFOR_LIBRARY_ADDRESS,
  INSTANT_VRF_ACTIONS_ADDRESS,
  ITEM_NFT_ADDRESS,
  LOCKED_BANK_VAULTS_ADDRESS,
  ORACLE_ADDRESS,
  PET_NFT_ADDRESS,
  PLAYERS_ADDRESS,
  PLAYER_NFT_ADDRESS,
  PROMOTIONS_ADDRESS,
  QUESTS_ADDRESS,
  SAMWITCH_VRF_ADDRESS,
  SHOP_ADDRESS,
  TERRITORIES_ADDRESS,
  RANDOMNESS_BEACON_ADDRESS,
  BRIDGE_ADDRESS,
  PASSIVE_ACTIONS_ADDRESS,
  BANK_FACTORY_ADDRESS,
  BANK_ADDRESS
} from "./contractAddresses";
import {deployPlayerImplementations} from "./utils";
import {
  Bridge,
  Clans,
  EggInstantVRFActionStrategy,
  EstforLibrary,
  InstantVRFActions,
  ItemNFT,
  LockedBankVaults,
  LockedBankVaultsLibrary,
  PetNFT,
  PetNFTLibrary,
  PlayerNFT,
  Players,
  PlayersLibrary,
  Promotions,
  Quests,
  Shop,
  Territories
} from "../typechain-types";
import {LockedBankVault} from "@paintswap/estfor-definitions/types";
import {makeSigner} from "../test/Players/utils";

import * as helpers from "@nomicfoundation/hardhat-network-helpers";

// When you need to fork a chain and debug
async function main() {
  const network = await ethers.provider.getNetwork();
  console.log(`ChainId: ${network.chainId}`);

  const owner = await ethers.getImpersonatedSigner("0x316342122A9ae36de41B231260579b92F4C8Be7f");

  const player = await ethers.getImpersonatedSigner("0x8ca12fb5438252ab8efa25d3fb34166eda1c17ed");
  const playerId = 3;

  await helpers.mine();

  const estforLibrary = await ethers.deployContract("EstforLibrary");
  // Players
  const playersLibrary = await ethers.deployContract("PlayersLibrary");
  const Players = (await ethers.getContractFactory("Players")).connect(owner);
  const players = (await upgrades.upgradeProxy(PLAYERS_ADDRESS, Players, {
    kind: "uups",
    unsafeAllow: ["delegatecall"]
  })) as unknown as Players;
  /*
  // Set the implementations
  const {playersImplQueueActions, playersImplProcessActions, playersImplRewards, playersImplMisc, playersImplMisc1} =
    await deployPlayerImplementations(await playersLibrary.getAddress());

  const tx = await players.setImpls(
    await playersImplQueueActions.getAddress(),
    await playersImplProcessActions.getAddress(),
    await playersImplRewards.getAddress(),
    await playersImplMisc.getAddress(),
    await playersImplMisc1.getAddress()
  );
  await tx.wait();

  // PlayerNFT
  const PlayerNFT = (
    await ethers.getContractFactory("PlayerNFT", {
      libraries: {EstforLibrary: await estforLibrary.getAddress()}
    })
  ).connect(owner);
  const playerNFT = (await upgrades.upgradeProxy(PLAYER_NFT_ADDRESS, PlayerNFT, {
    kind: "uups",
    unsafeAllow: ["external-library-linking"]
  })) as unknown as PlayerNFT;

  // Quests
  const Quests = await ethers.getContractFactory("Quests");
  const quests = (await upgrades.upgradeProxy(QUESTS_ADDRESS, Quests, {
    kind: "uups"
  })) as unknown as Quests;

  const Shop = await ethers.getContractFactory("Shop");
  const shop = (await upgrades.upgradeProxy(SHOP_ADDRESS, Shop, {
    kind: "uups"
  })) as unknown as Shop;

  // Create the world

  const RandomnessBeacon = await ethers.getContractFactory("RandomnessBeacon");
  const randomnessBeacon = await upgrades.upgradeProxy(RANDOMNESS_BEACON_ADDRESS, RandomnessBeacon, {
    kind: "uups",
    unsafeAllow: ["external-library-linking"]
  });

  // ItemNFT
  const itemNFTLibrary = await ethers.deployContract("ItemNFTLibrary");

  const ItemNFT = await ethers.getContractFactory("ItemNFT", {
    libraries: {ItemNFTLibrary: await itemNFTLibrary.getAddress()}
  });
  const itemNFT = (await upgrades.upgradeProxy(ITEM_NFT_ADDRESS, ItemNFT, {
    kind: "uups",
    unsafeAllow: ["external-library-linking"]
  })) as unknown as ItemNFT;

  const promotionsLibrary = await ethers.deployContract("PromotionsLibrary");
  const Promotions = await ethers.getContractFactory("Promotions", {
    libraries: {PromotionsLibrary: await promotionsLibrary.getAddress()}
  });
  const promotions = (await upgrades.upgradeProxy(PROMOTIONS_ADDRESS, Promotions, {
    kind: "uups",
    unsafeAllow: ["external-library-linking"]
  })) as unknown as Promotions;

  const Clans = await ethers.getContractFactory("Clans", {
    libraries: {EstforLibrary: await estforLibrary.getAddress()}
  });
  const clans = (await upgrades.upgradeProxy(CLANS_ADDRESS, Clans, {
    kind: "uups",
    unsafeAllow: ["external-library-linking"]
  })) as unknown as Clans;

  const lockedBankVaultsLibrary = await ethers.deployContract("LockedBankVaultsLibrary");

  const LockedBankVaults = await ethers.getContractFactory("LockedBankVaults", {
    libraries: {
      EstforLibrary: await estforLibrary.getAddress(),
      LockedBankVaultsLibrary: await lockedBankVaultsLibrary.getAddress()
    }
  });
  const lockedBankVaults = (await upgrades.upgradeProxy(LOCKED_BANK_VAULTS_ADDRESS, LockedBankVaults, {
    kind: "uups",
    unsafeAllow: ["external-library-linking"]
  })) as unknown as LockedBankVaults;

  const Territories = await ethers.getContractFactory("Territories");
  const territories = (await upgrades.upgradeProxy(TERRITORIES_ADDRESS, Territories, {
    kind: "uups",
    unsafeAllow: ["external-library-linking"]
  })) as unknown as Territories;

  const petNFTLibrary = await ethers.deployContract("PetNFTLibrary");
  const PetNFT = await ethers.getContractFactory("PetNFT", {
    libraries: {EstforLibrary: ESTFOR_LIBRARY_ADDRESS, PetNFTLibrary: await petNFTLibrary.getAddress()}
  });
  const petNFT = (await upgrades.upgradeProxy(PET_NFT_ADDRESS, PetNFT, {
    kind: "uups",
    unsafeAllow: ["external-library-linking"],
    timeout: 10000
  })) as unknown as PetNFT;
  await petNFT.waitForDeployment();

  const EggInstantVRFActionStrategy = await ethers.getContractFactory("EggInstantVRFActionStrategy");
  const eggInstantVRFActionStrategy = (await upgrades.upgradeProxy(
    EGG_INSTANT_VRF_ACTION_STRATEGY_ADDRESS,
    EggInstantVRFActionStrategy,
    {
      kind: "uups",
      timeout: 100000
    }
  )) as unknown as EggInstantVRFActionStrategy;
  await eggInstantVRFActionStrategy.waitForDeployment();

  const InstantVRFActions = await ethers.getContractFactory("InstantVRFActions");
  const instantVRFActions = (await upgrades.upgradeProxy(INSTANT_VRF_ACTIONS_ADDRESS, InstantVRFActions, {
    kind: "uups",
    timeout: 100000
  })) as unknown as InstantVRFActions;

  const Bank = (await ethers.getContractFactory("Bank")).connect(owner);
  const bank = await upgrades.upgradeBeacon(BANK_ADDRESS, Bank);
  console.log("Deployed bank beacon", await bank.getAddress());
  await bank.waitForDeployment();

  const BankFactory = (await ethers.getContractFactory("BankFactory")).connect(owner);
  const bankFactory = await upgrades.upgradeProxy(BANK_FACTORY_ADDRESS, BankFactory, {
    kind: "uups"
  });
  await bankFactory.waitForDeployment();
  console.log(`bankFactory = "${(await bankFactory.getAddress()).toLowerCase()}"`);
*/
  //  await players.connect(player).modifyXP("0x6dC225F7f21ACB842761b8df52AE46208705c942", 158, 12, 1109796, SKIP_XP_THRESHOLD_EFFECTS);
  const pendingQueuedActionState = await players.getPendingQueuedActionState(player.address, playerId);
  console.log(pendingQueuedActionState);

  /*
  // Debugging bridging
  const lzEndpoint = "0x1a44076050125825900e736c501f859c50fE728c";
  const Bridge = (await ethers.getContractFactory("Bridge")).connect(owner);
  const bridge = (await upgrades.upgradeProxy(BRIDGE_ADDRESS, Bridge, {
    kind: "uups",
    unsafeAllow: ["delegatecall", "constructor", "state-variable-immutable"],
    constructorArgs: [lzEndpoint]
  })) as unknown as Bridge;
  await bridge.waitForDeployment();
  console.log("Bridge upgraded");

  const data =
    "0xdcfdeb60000000000000000000000000e1dd69a2d08df4ea6a30a91cc061ac70f98aabe300000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000c4000000000000000000000000000000000000000000000000000000000000075a000000000000000000000000014b69305897a645ed5a4b542e4c45d629d0fe381000000000000000000000000000000000000000000000000000000000000004e0000000000000000000000006cfce945398b8f0cbe747e8dd04a3535978c718f863e6cb5cbba52d5e09d61cbb406dfc25162fb885d7fec7f0b7040a3641da17c00000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000bc000000000000000000000000000000000000000000000000000000000002625a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a800000000000000000000000000000000000000000000000000000000000000003000000000000000000000000ba00694692267ed0b5154d48fcb4d435d0b24d3f0000000000000000000000000000000000000000000000000000000000000402000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000003a000000000000000000000000000000000000000000000000000000000000003e000000000000000000000000000000000000000000000000000000000000004200000000000000000000000000000000000000000000000000000000000000460000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000004a000000000000000000000000000000000000000000000000000000000000006c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008e00000000000000000000000000000000000000000000000000000000000000900000000000000000000000000000000000000000000000000000000000000094000000000000000000000000000000000000000000000000000000000000009800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009c000000000000000000000000000000000000000000000000000000000000009e00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000a200000000000000000000000000000000000000000000000000000000000000a400000000000000000000000000000000000000000000000000000000000000a6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e53616d546573746572343833383100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000103939393939393939393939393939393900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f3939393939393939393939393939390000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f393939393939393939393939393939000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000009000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000b000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000d000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000000f00000000000000000000000000000000000000000000000000000000000000110000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001300000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001760000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000057061696e74000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a47345a67745035324a4b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000057061696e7400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

  try {
    const tx = await owner.sendTransaction({
      to: "0x83e72DA23b533b2083eD007223a491ba7EC3CcBe",
      data
    });

    const receipt = await tx.wait();
    console.log("Transaction hash:", receipt?.hash);
  } catch (error) {
    console.error(error);
  }
*/
  /*
  //  When trying to fix a VRF issue
  const randomnessBeacon = await ethers.getContractAt("RandomnessBeacon", RANDOMNESS_BEACON_ADDRESS);
  const samwitchVRFSigner = await makeSigner(SAMWITCH_VRF_ADDRESS);
  const tx = await randomnessBeacon
    .connect(samwitchVRFSigner)
    .fulfillRandomWords(
      ethers.toBeHex("101876967951259145252687976040413305757081568456854986909913200232326320008480", 32),
      [1323423423423423431111111111111111111n],
      {gasLimit: 600000}
    );
  await tx.wait();
  */
}

main().catch((error) => {
  console.error(error);
  process.exitCode = 1;
});
